Liquibase
=========

Подходы к управлению изменением базы данных: Состояние и Миграция
-----------------------------------------------------------------

Есть два подхода к управлению изменением базы данных. Первый подход декларативный (основан на состоянии) - в нем задается желаемое состояние базы данных. Используется инструмент который может сравнить текущее состояние и желаемое и сгенерировать скрипты миграции, способные перевести текущее состояние в желаемое. Альтернативный подход является императивным (основан на миграции) - в нем описываются конкретные действия по изменению состояния базы данных. Используется инструмент способный отследить и упорядочить индивидуальные миграции и применить их к текущему состоянии, чтобы достич желаемого состояния.

Несмотря на то, что Liquibase способна производить сравнения, фундаментально это императивное решение основанное на миграции. Способности Liquibase по сравнению предназначени только помочь с адаптацией новых проектов и для проверки результата применения миграции. Liquibase может:

* Отслеживать предложенные изменения базы данных, включая порядок их применения, кто автор или предложил изменение и сохранять цель изменения (как комментарий)

* Давать ясный ответ на вопрос, было ли применено изменение к базе данных. Фактически, Liquibase способна версионировать каждую базу данных

* Детерминированно применять изменения к базе данных, включая приведение базы данных к определенной "версии"

* Предотвращать изменения, которые уже были применены к базе данных и требовать чтоби они либо были намеренно применены повторно, либо roll-forward


Как работает Liquibase
----------------------

Liquibase полагается на простой механизм отслеживания, версионирования и применения изменений:

* Liquibase использует changeLog (являющийся гроссбухом изменений) для перечисления изменений базы данных в определенном порядоке. Каждое изменение в базе данных это "changeSet". ChangeLog может использовать вложенность чтобы помочь в организации и управлении миграциями.
    * Хорошей практикой является делать каждый changeSet настолько атомистичным наскольно возможно, чтобы избежать оставления базы данных в неизвестном состоянии в результате неудачных операций изменения, однако возможно использовать большой SQL скрипт как один changeSet.
* Liquibase использует отслеживающую таблицу 'DATABASECHANGELOG' создаваемую в каждой базе данных, которая содержит информации о том какой changeSet в changeLog-е уже применен
    * Если отслеживающей таблицы нет в базе данных на которой работает Liquibase, то она будет создана.
    * Чтобы помочь в работе над проектами где вы начинаете не с пустой базы данных Liquibase имеет возможность генерации changeLog-а представляющего текущее состояние схемы базы данных.
    
С помощью гроссбуха и отслеживающей таблицы Liquibase может:

* Отслеживать и версионировать изменения базы данных - так что пользователи точно знают, какие изменения применены к базе данных, а какие еще нет.
* Применять изменения - а именно сравнивая то, что записано в гросбухе с тем, что в отслеживающей таблице. Liquibase способна применять только те изменения, которые еще не были пременены к базе данных.
    * Liquibase имеет продвинутые возможности такие как контексты, метки (labels) и предусловия для точного контроля когда и где changeSet-ы будут применены.
    
    
Руководства: Отслеживание, Версионирование и Применение Изменений в Базе Данных с помощью Liquibase
---------------------------------------------------------------------------------------------------

При работе с Liquibase изменения могут быть заданы с помощью Объектной модели Liquibase или с помощью SQL. Эти режимы не являются взаимно исключающими и могут использваться совместно, предоставляя значительную гибкость в том как измененния базы данных определены и применяются. Для изменений, заданных с помощью объектной модели Liquibase, генерируются SQL скрипты соответствующие целевой базе данных. Это может быть полезно в случаях:

* Поддержка нескольких различных БД бэкэндов. Это частый случай если вы хотите избежать написания одинаковых миграций для поддержки различных БД платформ.
* Предоставление разработчикам, не обладающих достаточным знанием SQL, возможности задать изменения базы данных. Вместо SQL, миграции могут быть описаны в XML, JSON или YAML.
* Стандартизация изменения базы данных. Liquibase генерирует синтаксически и стилистически постоянный SQL, обеспечивая, например, чтобы все миграции 'CREATE TABLE' имели постоянный стиль и шаблон.

Как альтернатива Liquibase работает напрямую с предоставленными пользователями миграциями. Это может быть полезно если:

* Применяются изменения не являющиеся частью объектной модели Liquibase. Изменения специфичные для базы данных - например вложенные таблицы Oracle, которые не входят в объектную модель Liquibase.
* Нужно предоставить опытным экспертам SQL возможности работать напрямую с SQL. Liquibase имеет полную поддержку SQL скриптов.


Руководство по использованию SQL
--------------------------------

### Настроить Change Log

Необходимо сконфигурировать change log, чтобы он указывал на директорию sql содержащую SQL скрипты. Содержимое файла myChangeLog.xml:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <includeAll path="/sql"/>
</databaseChangeLog>
```

### Добавить SQL скрипт в директорию sql

Liquibase упорядочивает скрипты по алфавиту. Нужно создать файл 001_create_person_table.sql и сохранить его в директории `sql`:

```sql
create table PERSON (
    ID int not null,
    FNAME varchar(100) not null
);
```

### Применить первое изменение

Выполнить в терминале `./liquibase update` или `liquibase.bat update`.

### Проверить базу данных

База данных должна теперь содержать таблицу `PERSON`.
